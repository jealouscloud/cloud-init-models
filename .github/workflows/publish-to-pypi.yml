name: Publish to PyPI

on:
  release:
    types: [published]
  workflow_dispatch:

jobs:
  publish:
    runs-on: ubuntu-latest
    container:
      image: debian:latest
    
    permissions:
      contents: read
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Install system dependencies
        run: |
          apt-get update
          apt-get install -y cloud-init python3 python3-pip python3-venv git
      
      - name: Set up Python virtual environment and install uv
        run: |
          python3 -m venv /opt/venv
          . /opt/venv/bin/activate
          pip install --upgrade pip
          pip install uv
      
      - name: Install datamodel-code-generator and build tools
        run: |
          . /opt/venv/bin/activate
          uv pip install datamodel-code-generator build
      
      - name: Generate cloud_init_models source directory
        run: |
          . /opt/venv/bin/activate
          # Generate models from cloud-init schemas
          # The actual schema location will depend on cloud-init installation
          if [ -d "/usr/lib/python3/dist-packages/cloudinit" ]; then
            echo "Cloud-init found, generating models..."
            # Find cloud-init schema files and generate models
            # Example: datamodel-codegen --input /path/to/schemas --output cloud_init_models
            # TODO: Implement actual schema generation based on cloud-init structure
            # For now, using the committed package structure
            echo "Using committed package structure"
          else
            echo "Warning: cloud-init not found at expected location"
          fi
      
      - name: Build package
        run: |
          . /opt/venv/bin/activate
          python3 -m build
      
      - name: Publish to PyPI
        env:
          UV_PUBLISH_TOKEN: ${{ secrets.PYPI_API_TOKEN }}
        run: |
          . /opt/venv/bin/activate
          uv publish
