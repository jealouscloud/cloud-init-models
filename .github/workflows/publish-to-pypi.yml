name: Publish to PyPI

on:
  release:
    types: [published]
  workflow_dispatch:

jobs:
  publish:
    runs-on: ubuntu-latest
    container:
      image: debian:latest
    
    permissions:
      contents: read
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Install system dependencies
        run: |
          apt-get update
          apt-get install -y cloud-init python3 python3-pip python3-venv git
      
      - name: Set up Python virtual environment and install uv
        run: |
          python3 -m venv /opt/venv
          . /opt/venv/bin/activate
          pip install --upgrade pip
          pip install uv
      
      - name: Install datamodel-code-generator and build tools
        run: |
          . /opt/venv/bin/activate
          uv sync
      
      - name: Generate cloud_init_models source directory
        run: |
          . /opt/venv/bin/activate
          # Generate models from cloud-init schemas
          cfg=$(dpkg -L cloud-init | grep cloud-config-v1.json)
          if [[ -z "$cfg" ]]; then
            echo "Error: cloud-config-v1.json not found"
            exit 1
          fi
          cp "$cfg" ./schema.json
          uv run  datamodel-codegen --input ./schema.json --input-file-type jsonschema  --output-model-type typing.TypedDict --output cloud_init_models/models/
          
      
      - name: Build package
        run: |
          . /opt/venv/bin/activate
          python3 -m build
      
      - name: Publish to PyPI
        env:
          UV_PUBLISH_TOKEN: ${{ secrets.PYPI_API_TOKEN }}
        run: |
          . /opt/venv/bin/activate
          uv publish
